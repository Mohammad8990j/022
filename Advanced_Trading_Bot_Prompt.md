**هدف**: طراحی و پیاده‌سازی یک ربات تریدر خودکار پیشرفته برای بازارهای مالی (فارکس، سهام، یا کریپتو) با اتصال به متاتریدر ۵ (MT5). ربات باید از مدل‌های یادگیری ماشین مبتنی بر PyTorch (بدون استفاده از TensorFlow) استفاده کند، استراتژی‌های متنوع را پشتیبانی کند، مدل‌ها پس از آموزش ذخیره شوند تا در آینده قابل استفاده باشند، مدل‌ها به‌صورت هفتگی با داده‌های جدید به‌روزرسانی شوند، قابلیت بک‌تست داشته باشد، و دارای رابط کاربری فارسی، مدرن، و کاربرپسند باشد.

---

**نیازمندی‌های اصلی**:

1. **مدل‌های یادگیری ماشین** (همه با PyTorch):
   - **یادگیری تقویتی**:
     - پیاده‌سازی الگوریتم‌های PPO و DQN با استفاده از Stable-Baselines3 در محیط Gym.
     - محیط Gym شامل داده‌های قیمت (OHLC)، اندیکاتورها (RSI، MA، MACD، MFI)، و پاداش مبتنی بر سود/زیان معاملات.
   - **یادگیری نظارتی**:
     - مدل **CNN** با PyTorch برای پیش‌بینی حرکت قیمت (صعودی، نزولی، خنثی) با ورودی سری‌های زمانی (۲۰ کندل).
     - مدل **ترنسفورمر** با PyTorch برای تحلیل سری‌های زمانی چندمتغیره (قیمت و اندیکاتورها).
     - مدل **LSTM** با PyTorch برای مدل‌سازی وابستگی‌های زمانی در داده‌های مالی.
   - **ترکیب مدل‌ها**:
     - استفاده از میانگین وزنی یا رأی‌گیری برای ترکیب پیش‌بینی‌های مدل‌ها (خرید، فروش، نگه‌داشتن).
   - **ذخیره‌سازی مدل‌ها**:
     - پس از هر بار آموزش، مدل‌ها (PPO، DQN، CNN، LSTM، ترنسفورمر) در فایل‌هایی با فرمت مناسب (مانند `.pt` برای PyTorch) ذخیره شوند.
     - امکان بارگذاری مدل‌های ذخیره‌شده برای استفاده در ترید یا بک‌تست بدون نیاز به آموزش مجدد.
   - **به‌روزرسانی هفتگی**:
     - اسکریپتی برای به‌روزرسانی خودکار مدل‌ها با داده‌های جدید هر هفته.
     - دریافت داده‌های جدید از MT5، پیش‌پردازش، و آموزش مجدد یا تنظیم دقیق (fine-tuning) مدل‌ها.
     - ذخیره نسخه جدید مدل‌ها و آرشیو نسخه‌های قدیمی برای مقایسه.

2. **اتصال به متاتریدر**:
   - اتصال پایدار با کتابخانه `MetaTrader5` شامل:
     - لاگین امن، مدیریت خطاها، و بررسی دوره‌ای اتصال.
     - دریافت داده‌های تاریخی (OHLC، حجم) و داده‌های تیک (bid/ask) به‌صورت بلادرنگ.
   - مدیریت سفارشات:
     - ارسال سفارشات خرید/فروش، تنظیم حد ضرر (SL) و حد سود (TP)، بستن معاملات.
   - مدیریت حساب:
     - بررسی موجودی، مارجین، و معاملات باز.
     - تنظیم پویا پارامترها (نماد، حجم، SL، TP).

3. **بک‌تست**:
   - ماژول بک‌تست برای ارزیابی تمام مدل‌ها روی داده‌های تاریخی.
   - نمایش نتایج بصری (سود/زیان، Drawdown) با Matplotlib یا Plotly.
   - محاسبه معیارهای عملکرد:
     - Sharpe Ratio، Sortino Ratio، Win Rate.
   - پشتیبانی از استراتژی‌های مختلف:
     - HFT (فرکانس بالا)، روندی، ضدروندی، اسکلپ.
   - بهینه‌سازی پارامترها با Grid Search یا روش‌های مشابه.

4. **پویایی**:
   - امکان تغییر نماد، حجم، SL، TP، و تایم‌فریم از طریق رابط کاربری یا فایل تنظیمات.
   - ذخیره تنظیمات در فایل JSON یا YAML.
   - ادغام با رابط کاربری برای اعمال تنظیمات به‌صورت کاربرپسند.

5. **نمایش نمودار**:
   - نمایش نمودارهای کندلی یا خطی مشابه متاتریدر با Matplotlib یا Plotly.
   - به‌روزرسانی بلادرنگ نمودارها با داده‌های تیک.
   - نمایش اندیکاتورهای RSI، MA، MACD، MFI روی نمودار.
   - قابلیت زوم، اسکرول، و نمایش نقاط ورود/خروج معاملات.

6. **دیباگ و پایداری**:
   - سیستم لاگینگ جامع با ماژول `logging` برای ثبت تمام عملیات، تصمیمات، و خطاها.
   - تست‌های واحد با `pytest` برای هر ماژول (داده، مدل‌ها، ترید، UI).
   - مدیریت خطاها با مکانیزم‌های Retry و Fail-Safe.
   - تست پایداری طولانی‌مدت در حساب دمو (حداقل یک ماه).

7. **رابط کاربری فارسی**:
   - رابط کاربری با PyQt5 یا PySide6 شامل بخش‌های:
     - تنظیمات (نماد، تایم‌فریم، استراتژی)، نمودارها، بک‌تست، آموزش/به‌روزرسانی مدل، ترید زنده، اطلاعات حساب.
   - پشتیبانی از تنظیمات پویا و به‌روزرسانی بلادرنگ وضعیت حساب و معاملات.
   - متون، پیام‌ها، و راهنماها به زبان فارسی.

8. **محیط گرافیکی مدرن**:
   - طراحی زیبا با تم‌های روشن و تیره، آیکون‌های حرفه‌ای، و انیمیشن‌های نرم.
   - تجربه کاربری بهینه با دسترسی سریع به ابزارها و تنظیمات.

9. **استراتژی‌های متنوع**:
   - **HFT**: مدل‌های سریع مبتنی بر داده‌های تیک.
   - **روندی**: استفاده از MA، ADX.
   - **ضدروندی**: استفاده از RSI، Stochastic.
   - **اسکلپ**: استفاده از الگوهای کندل‌استیک، RSI، MFI.
   - امکان انتخاب استراتژی از رابط کاربری یا فایل تنظیمات.

10. **اجرای واقعی**:
    - پایداری در حساب‌های دمو و واقعی.
    - مدیریت هزینه‌های ترید (اسپرد، کارمزد).
    - اجرای به‌روزرسانی خودکار مدل‌ها هر هفته با داده‌های جدید.

---

**ساختار پروژه**:
```
Advanced Trading Bot/
├── data/
│   ├── historical/        # ذخیره داده‌های تاریخی
│   ├── live/              # ذخیره داده‌های تیک و بلادرنگ
│   └── processed/         # داده‌های پیش‌پردازش‌شده
├── models/
│   ├── cnn/               # ذخیره مدل‌های CNN
│   ├── lstm/              # ذخیره مدل‌های LSTM
│   ├── transformer/       # ذخیره مدل‌های ترنسفورمر
│   ├── ppo/               # ذخیره مدل‌های PPO
│   └── dqn/               # ذخیره مدل‌های DQN
│   └── archived/          # آرشیو نسخه‌های قدیمی مدل‌ها
├── saved_models/          # ذخیره مدل‌های آموزش‌دیده
│   ├── cnn_model_2025_04_15.pt
│   ├── lstm_model_2025_04_15.pt
│   ├── transformer_model_2025_04_15.pt
│   ├── ppo_model_2025_04_15.pt
│   └── dqn_model_2025_04_15.pt
├── configs/
│   ├── settings.yaml      # تنظیمات کلی ربات (زبان، استراتژی، SL، TP، و غیره)
│   ├── strategies.yaml    # تنظیمات استراتژی‌ها
│   └── credentials.yaml   # اطلاعات ورود متاتریدر (امن)
├── src/
│   ├── connectors/
│   │   ├── mt5_connector.py        # ماژول اتصال به متاتریدر ۵
│   │   └── data_fetcher.py         # دریافت داده‌های تاریخی و بلادرنگ
│   ├── preprocessing/
│   │   └── feature_engineering.py  # پیش‌پردازش داده‌ها (اندیکاتورها، نرمال‌سازی)
│   ├── models/
│   │   ├── cnn_model.py            # مدل CNN
│   │   ├── lstm_model.py           # مدل LSTM
│   │   ├── transformer_model.py    # مدل ترنسفورمر
│   │   └── reinforcement.py        # مدل‌های PPO و DQN
│   ├── trading/
│   │   ├── order_manager.py        # مدیریت سفارشات (باز، بسته، SL، TP)
│   │   ├── backtester.py           # ماژول بک‌تست
│   │   └── live_trader.py          # ترید زنده
│   ├── ui/
│   │   ├── main_window.py          # رابط کاربری اصلی
│   │   ├── charts.py               # نمایش نمودارها
│   │   └── settings_window.py      # تنظیمات رابط کاربری
│   ├── evaluation/
│   │   ├── metrics.py              # محاسبه معیارهای عملکرد
│   │   ├── optimizer.py            # بهینه‌سازی پارامترها
│   └── utils/
│       ├── logger.py               # سیستم لاگینگ
│       ├── config_loader.py        # بارگذاری تنظیمات
│       └── error_handler.py        # مدیریت خطاها
├── scripts/
│   ├── weekly_update.py            # اسکریپت به‌روزرسانی هفتگی مدل‌ها
│   ├── model_trainer.py            # آموزش مدل‌ها
│   └── data_updater.py             # به‌روزرسانی داده‌ها
├── tests/
│   ├── test_models.py              # تست واحد برای مدل‌ها
│   ├── test_connectors.py          # تست واحد برای اتصال به MT5
│   └── test_ui.py                  # تست رابط کاربری
├── requirements.txt                # لیست کتابخانه‌های مورد نیاز
├── README.md                       # توضیحات پروژه
└── main.py                         # نقطه شروع برنامه
```

---

**فازبندی پروژه**:

### 🟢 فاز ۱: آماده‌سازی محیط، ساختار و تنظیمات
هدف: ایجاد شالوده پروژه و فراهم‌کردن زیرساخت لازم

1. ساخت پوشه‌ها و فایل‌های اولیه مطابق ساختار پیشنهادی.
2. نوشتن فایل‌های `requirements.txt` و `README.md`.
3. تعریف فایل‌های تنظیمات:
   - `settings.yaml` (زبان، SL، TP، تایم‌فریم، نماد، و غیره).
   - `strategies.yaml` (تنظیمات استراتژی‌ها).
   - `credentials.yaml` (ورود امن به متاتریدر).
4. پیاده‌سازی:
   - `logger.py` برای لاگ جامع.
   - `config_loader.py` برای بارگذاری تنظیمات YAML.
   - `error_handler.py` برای مدیریت استثناها و Retry.

---

### 🟡 فاز ۲: اتصال به متاتریدر و دریافت داده‌ها
هدف: ارتباط پایدار با MT5 و دریافت داده بلادرنگ و تاریخی.

1. **ماژول‌ها**:
   - `mt5_connector.py`: اتصال، لاگین، مدیریت خطا، بررسی اتصال.
   - `data_fetcher.py`: دریافت داده‌های OHLC، تیک و ذخیره در `data/historical/` و `data/live/`.
2. امکان تست دریافت داده به‌صورت واحد (`test_connectors.py`).

---

### 🟠 فاز ۳: پیش‌پردازش و استخراج ویژگی‌ها
هدف: تبدیل داده خام به ورودی مناسب برای مدل‌های یادگیری ماشین.

1. **ماژول‌ها**:
   - `feature_engineering.py`: افزودن اندیکاتورها (RSI، MFI، MACD، MA)، نرمال‌سازی داده‌ها، و ساخت پنجره‌های زمانی.
2. ذخیره داده پردازش‌شده در `data/processed/`.

---

### 🔵 فاز ۴: پیاده‌سازی مدل‌های یادگیری ماشین (با PyTorch)
هدف: آموزش و استفاده از مدل‌ها برای پیش‌بینی بازار.

1. **ماژول‌ها**:
   - `cnn_model.py`: مدل CNN.
   - `lstm_model.py`: مدل LSTM.
   - `transformer_model.py`: مدل ترنسفورمر.
   - `reinforcement.py`: الگوریتم PPO و DQN با Stable-Baselines3.
2. **ذخیره‌سازی**:
   - مدل‌ها در پوشه `saved_models/` با فرمت `.pt`.

---

### 🟣 فاز ۵: آموزش، ذخیره و به‌روزرسانی خودکار مدل‌ها
هدف: آموزش اولیه و سپس به‌روزرسانی هفتگی بر اساس داده‌های جدید.

1. **ماژول‌ها**:
   - `scripts/model_trainer.py`: آموزش مدل CNN/LSTM/Transformer.
   - `scripts/weekly_update.py`: دریافت داده هفته جدید، Fine-tune مدل‌ها، و ذخیره نسخه جدید.

---

### 🔴 فاز ۶: ترید زنده و مدیریت سفارشات
هدف: اجرای معاملات زنده با پیش‌بینی مدل‌ها و کنترل سفارشات.

1. **ماژول‌ها**:
   - `live_trader.py`: پیش‌بینی لحظه‌ای و تصمیم‌گیری.
   - `order_manager.py`: مدیریت سفارشات.

---

### 🟤 فاز ۷: بک‌تست حرفه‌ای و ارزیابی عملکرد
هدف: سنجش عملکرد مدل‌ها و استراتژی‌ها روی داده تاریخی.

1. **ماژول‌ها**:
   - `backtester.py`: شبیه‌سازی معاملات.
   - `metrics.py`: محاسبه Sharpe Ratio و سایر معیارها.

---

### 🟧 فاز ۸: طراحی رابط کاربری فارسی و حرفه‌ای
هدف: کنترل کامل ربات از طریق UI با ظاهر مدرن و زبان فارسی.

1. **ماژول‌ها**:
   - `main_window.py`: پنجره اصلی.
   - `charts.py`: نمایش نمودارها.
   - `settings_window.py`: تنظیمات.

---

### ⚫ فاز ۹: تست، پایداری و آماده‌سازی نسخه نهایی
هدف: تضمین کیفیت، پایداری و تست روی حساب دمو.

1. تست واحد برای همه ماژول‌ها با `pytest`.
2. مستندسازی کامل و آماده‌سازی نسخه اجرایی.